---
id: '75991711'
title: 'កែប្រែ​ការផ្សាយ'
categories: 'Node.js, Astro'
thumb: ''
date: '2025-08-31T15:19:04'
bookTitle: 'Astro Dynamic Website'
bookThumb: ''
bookChapter: 'ទំព័រ​ការផ្សាយ'
videos: ''
---
<p>ការកែប្រែ​ទិន្នន័យ​នៃ​ការផ្សាយ​ត្រូវ​ធ្វើ​ឡើង​ជា​ពីរ​ដំណាក់កាល​។ ដំណាក់កាល​ទី​មួយ​គឺ​ការស្រង់​​យក​ទិន្នន័យ​ដែល​ត្រូវ​កែប្រែមក​ដាក់​បង្ហាញ​នៅ​លើ​​ទំព័រ​ការផ្សាយ​។ ដំណាក់កាល​ទី​ពីរ​គឺ​ការកែប្រែ​ទិន្នន័យ​និង​បញ្ជូន​ទិន្នន័យ​នេះ​ទៅ​ជំនួស​ទិន្នន័យ​ចាស់​នៅ​ក្នុង​មូលដ្ខាន​ទិន្នន័យ​។</p><p>&nbsp;</p><p>យើង​បាន​ដឹង​រួច​មក​ហើយ​ថា ការស្រង់​យក​ទិន្នន័យ​ណា​មួយ គឺ​ត្រូវ​ធ្វើឡើង​តាម​រយៈ​អត្តសញ្ញាណ​ id ដែល​នឹង​ត្រូវ​ជា​ផ្នែក​មួយ​នៃ​ផ្លូវ​ឌីណាមិក។ ដូចនេះ​ យើង​អាច​កំណត់​ផ្លូវ​ឌីណាមិក​មួយ​ដែល​មាន​អត្តសញ្ញាណ id របស់​ទិន្នន័យ​នៃ​ការផ្សាយ​និមួយ​ៗ​ដូ​ច​ខាង​ក្រោមនេះ​៖</p><pre><code class="js javascript js-code">// src/models/post.js
import prisma from './prisma.js'

class Post{
	...
    async getPost(params){
        return await prisma.post.findUnique({ where: {id: params.id }})
    }

    async deletePost(params){
        await prisma.post.delete({ where: {id: params.id } })
    }

    async updatePost(newPost, params){
        await prisma.post.update({ where: {id: params.id }, data: newPost })
    }
}

export default new Post()</code></pre><pre><code class="js javascript js-code">&lt;!--src/admin/post/edit/[id].astro--&gt;
---
// @ts-nocheck
const user = await Astro.session?.get('user')
if(!user){return Astro.redirect('/login')}

import Layout from "../../../../components/admin/Layout.astro"
import Post from "../../../../components/admin/Post-edit.svelte"
import postDb from "../../../../models/post.js"
import setup from "../../../../settings.js"
const settings = await setup()
const items = await postDb.getPosts(settings.dashboard)
const count = await postDb.count()
const post = await postDb.getPost(Astro.params)
const pageNumber = Math.ceil(count/settings.dashboard)
const categories = [] //await categoryDB.getAllItems(locals)
const params = Astro.url.searchParams
const navPage = params.get("p")

const data = { user, post, count, settings, items, categories, info:"ការផ្សាយ", type:"post", pageNumber, navPage }

if(Astro.request.method === "POST"){
    let message = {}
    const formData = await Astro.request.formData()
    const title = formData.get('title')
    const content = formData.get('content')
    const categories = formData.get('categories')
    const thumb = formData.get("thumb")
    const date = formData.get("datetime")
    const videos = formData.get("videos")

    const validate = (
        typeof title === 'string' &amp;&amp; title !== '' &amp;&amp;
        typeof content === 'string' &amp;&amp;
        typeof categories === 'string' &amp;&amp; categories !== '' &amp;&amp;
        typeof thumb === 'string' &amp;&amp; thumb !== '' &amp;&amp;
        typeof date === 'string' &amp;&amp; date !== '' &amp;&amp;
        typeof videos === 'string'
    )

    if(validate){
        const newPost = { title, content, categories, thumb, date, videos }
        if(user.role !== 'Admin'){
            if(post.author === user.id){
                await postDb.updatePost(newPost, Astro.params)
                message.info = 'កែប្រែ​បាន​ដោយ​ជោគជ័យ!'
                message.success = true
            }else{
                message.info = 'អ្នក​មិន​អាច​កែប្រែ​ការផ្សាយ​របស់​អ្នក​ផ្សេង​បាន​ឡើយ!'
                message.success = false
            }
        }else if(user.role === 'Admin'){
            await postDb.updatePost(newPost, Astro.params)
            message.info = 'កែប្រែ​បាន​ដោយ​ជោគជ័យ!'
            message.success = true
        }
    }else{
        message.info = "ទិន្នន័យ​បញ្ជូន​មក​មិន​ត្រឹមត្រូវ​ទេ!"
        message.success = false
    }

    data.post = await postDb.getPost(Astro.params)
    data.items = await postDb.getPosts(settings.dashboard)
    data.count = await postDb.count()
    data.pageNumber = Math.ceil(count/settings.dashboard)
    data.form = message
}
---

&lt;Layout title="កែប្រែ​ការផ្សាយ" data={data} &gt;
    &lt;Post slot="editor" {data} client:load /&gt;
&lt;/Layout&gt;</code></pre><pre><code class="svelte">&lt;!--src/components/admin/Post-edit.svelte--&gt;
&lt;script&gt;
    // npm install jquery
    import jq from 'jquery'
    import { activePage } from "../../stores/page.js"
    let { data } = $props()
    let category = $state(undefined)
    let categories = $state(data.post.categories)
    let json = $state(data.post.videos)
    let type = $state(undefined)
    let id = $state(undefined)
    let status = $state(undefined)
    let videos = $state([])
    if(data.post?.videos.length){
        videos = JSON.parse(data.post.videos)
    }

    function getCategory(){
        if(categories === ''){
            categories += category
        }else{
            categories += (`, ${category}`)
        }
    }

    function submitForm(){
        window.onbeforeunload = null
        if(videos.length){
            let newVideos = []
            let part = {}
            let key = {0:'type', 1:'id', 2:'status'}

            for(let v=1; v&lt;=videos.length; v++){
                for(let j=0; j&lt;3; j++){
                    part[key[j]] = jq(`.viddata div:eq(${v}) input:eq(${j})`).val()
                }

                newVideos.push({...part})
            }

            json = JSON.stringify(newVideos)
        }else{
            json = ''
        }
    }

    const genJson = () =&gt; {        
        let video = {type, id, status}
        let success = false
    
        for(let v in video){
            if(!video[v]){
                alert('ចូរ​បំពេញ​កន្លែង​អត្តសញ្ញាណ​វីដេអូ')
                success = false
                break
            }else{
                success = true
            }
        }

        if(success){
            videos = [video, ...videos]
            json = JSON.stringify(videos)
        }  
    }

    function deleteRow(e) {
        let index = parseInt(e.target.innerHTML)
        videos.splice(videos.length - index, 1)
    }

    function save_data_check(){   
        return "Your changes may not be saved."
    }

    $effect(()=&gt;{
        jq('.Editor input').on('change', () =&gt; {
            window.onbeforeunload = save_data_check
        })

        ckeditor.model.document.on( 'change', () =&gt; {
            window.onbeforeunload = save_data_check
        } )
    })
&lt;/script&gt;

&lt;div class="Editor"&gt;
    &lt;script src="/scripts/ckeditor/ckeditor.js"&gt;&lt;/script&gt;
    &lt;form action="/admin/post/edit/{data.post.id}?p={$activePage}" method="post" onsubmit={submitForm}&gt;
        &lt;input type="text" name="title" value={data.post.title} required placeholder="ចំណងជើង" /&gt;
        &lt;div class="wrapper"&gt;
            &lt;textarea name="content" id="editor"&gt;{data.post.content}&lt;/textarea&gt;
        &lt;/div&gt;
        &lt;input type="text" bind:value={categories} name="categories" required placeholder="ជំពូក" /&gt;
        &lt;div class="frame"&gt;
            &lt;select name="category" bind:value={category} onchange={getCategory} &gt;
                &lt;option disabled selected&gt;ជ្រើសរើស​យក​ជំពូក&lt;/option&gt;
                {#each data?.categories as category}
                &lt;option&gt;{category.title}&lt;/option&gt;
                {/each}
            &lt;/select&gt;
            &lt;input type="text" name="thumb" value={data.post.thumb} required placeholder="រូប​​តំណាង" /&gt;
            &lt;input type="datetime-local" value={data.post.date} step="1" name="datetime" required /&gt;
            &lt;input type="submit" value="ចុះ​ផ្សាយ" /&gt;
            &lt;input type="hidden" name="videos" bind:value={json} /&gt;
        &lt;/div&gt;
        &lt;script src="/scripts/ckeditor/config.js"&gt;&lt;/script&gt;
    &lt;/form&gt;
    &lt;div class='form'&gt;
        &lt;select name='type' bind:value={type} &gt;
            &lt;option&gt;YouTube&lt;/option&gt;
            &lt;option&gt;YouTubePlaylist&lt;/option&gt;
            &lt;option&gt;Facebook&lt;/option&gt;
            &lt;option&gt;OK&lt;/option&gt;
            &lt;option&gt;Dailymotion&lt;/option&gt;
            &lt;option&gt;Vimeo&lt;/option&gt;
        &lt;/select&gt;
        &lt;input name='videoid' bind:value={id} type='text' placeholder="អត្តសញ្ញាណ​វីដេអូ" required /&gt;
        &lt;select name='status' bind:value={status} &gt;
            &lt;option&gt;ចប់&lt;/option&gt;
            &lt;option&gt;នៅ​មាន​ត&lt;/option&gt;
            &lt;option&gt;~ ចប់&lt;/option&gt;
        &lt;/select&gt;
        &lt;input onclick={genJson} type="button" value="បញ្ចូលវីដេអូ" /&gt;
    &lt;/div&gt;
    &lt;div class='viddata'&gt;
        &lt;div&gt;
            {#if videos.length}
            &lt;b&gt;ប្រភេទ​វីដេអូ​&lt;/b&gt;&lt;b&gt;អត្តសញ្ញាណ​វីដេអូ​&lt;/b&gt;&lt;b&gt;ស្ថានភាព&lt;/b&gt;&lt;b&gt;ភាគ/លុប&lt;/b&gt;
            {/if}
        &lt;/div&gt;
        {#each videos as video, i}
        &lt;div&gt;
            &lt;input value={video.type} required /&gt;
            &lt;input value={video.id} required /&gt;
            &lt;input value={video.status} required /&gt;
            &lt;p title="Delete" onclick={deleteRow} class="episode"&gt;{videos.length-i}&lt;/p&gt;
        &lt;/div&gt;
        {/each}
    &lt;/div&gt;
&lt;/div&gt;

&lt;style&gt;
    .Editor{
        background-color: white;
        height: 100%;
    } 
    .Editor .wrapper{
        height: 310px;
    }
    .Editor input, .Editor select,
    .Editor .form input, .Editor .form select{
        width: 100%;
        font: var(--body-font);
        padding: 3px 5px;
    }
    .Editor .frame, .Editor .form, .Editor .viddata div{
        display: grid;
        grid-template-columns: 20% 32.5% 32.5% 15%;
    }
    .Editor .viddata div{
        width: 100%;
    }
    .Editor .viddata div p:hover{
        cursor: pointer;
        color: red;
    }
    .Editor .viddata b,
    .Editor .viddata input,
    .Editor .viddata p{
        font: var(--body-font);
        padding: 5px;
        background: lightgrey;
        border: 1px solid grey;
        text-align: center;
        color: black;
    }
    .Editor .viddata input{
        background: white;
    }
&lt;/style&gt;</code></pre><pre><code class="svelte">&lt;!--src/components/admin/Item.svelte--&gt;
&lt;script&gt;
	import { activePage } from "../../stores/page.js"
    let { data } = $props()
	let items = $state(data?.items)
	let value = $state(undefined)
	$effect(() =&gt; { $activePage = value })
	let navPage = data?.navPage || 1
	
	async function paginate(e){
		const response = await fetch(`/admin/${data.type}/paginate/${e.target.value}`)
		items = await response.json()
	}
&lt;/script&gt;

&lt;footer&gt;
	{#if data?.form}
	&lt;div class="{data.form.success ? 'success':'error'}"&gt;{ data.form.info }&lt;/div&gt;
	{/if}
    &lt;div class="info"&gt;{data?.info}​ទាំងអស់​មានចំនួនៈ {data?.count}&lt;/div&gt;
    &lt;div class="items"&gt;
        {#each items as item}
        &lt;div class="item"&gt;
            &lt;a class="thumb" href="/{data.type}/{item.id}"&gt;
                &lt;img src={item.thumb} alt='' /&gt;
                {#if item.videos?.length}
                &lt;img class="play" src="/images/play.png" alt='' /&gt;
                {/if}
            &lt;/a&gt;
            &lt;div class="title"&gt;
                &lt;a href="/{data.type}/{item.id}"&gt;{item.title}&lt;/a&gt;
                &lt;div&gt;{new Date(item.date).toLocaleDateString('it-IT')}&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="edit"&gt;
				&lt;a href="/admin/{data.type}/delete/{item.id}"&gt;
					&lt;img src="/images/delete.png" alt=''/&gt;
				&lt;/a&gt;
                &lt;a style="padding-right:5px;" href={`/admin/${data.type}/edit/${item.id}?p=${value}`}&gt;
					&lt;img src="/images/edit.png" alt='' /&gt;
				&lt;/a&gt;
            &lt;/div&gt; 
        &lt;/div&gt;
        {/each}
    &lt;/div&gt;
	&lt;div class="pagination"&gt;
		&lt;span&gt;​​​​​​​​​​​​​​​​​​​​​ទំព័រ &lt;/span&gt;
			&lt;select bind:value onchange={paginate}&gt; 
				{#each [...Array(data?.pageNumber).keys()] as page}
					{#if page+1 == parseInt(navPage)}
					&lt;option selected&gt;{page+1}&lt;/option&gt;
					{:else}
					&lt;option&gt;{page+1}&lt;/option&gt;
					{/if}
				{/each}
			&lt;/select&gt; 
            
        &lt;span&gt;នៃ {data?.pageNumber}&lt;/span&gt;
	&lt;/div&gt;
&lt;/footer&gt;

&lt;style&gt;
    footer{
		margin-top: 0;
	}
	footer .success, footer .error{
		background-color: green;
		text-align: center;
		margin-top: 10px;
		padding: 5px;
		color: white;
	}
	footer .error{
		background-color: red;
	}
	footer .info{
		background-color: var(--background);
		text-align: center;
		margin-top: 10px;
		padding: 5px;
	}
	footer .items{
		display: grid;
		grid-template-columns: calc(50% - 5px ) calc(50% - 5px );
		grid-gap: 10px;
		margin-top: 10px;
	}
	footer .items .item{
		background-color: var(--background);
		display: grid;
		grid-template-columns: 130px auto;
		grid-gap: 10px;
		align-items: center;
		padding-right: 10px;
	}
	footer .items .item:hover{
		grid-template-columns: 130px auto 75px;
	}
	footer .items .item .thumb{
		position: relative;
		padding-top: 56.25%;
		overflow: hidden;
	}
	footer .items .item .thumb img{
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		min-height: 100%;
		float: left;
	}
	footer .items .item .thumb .play{
		width: 25%;
		top: 50%;
    	left: 50%;
		min-height: auto;
		transform: translate(-50%,-50%);
	}
	footer .items .item .title{
		white-space: nowrap;
        overflow: hidden;
    	text-overflow: ellipsis;
		
	}
	footer .items .item .edit{
    	text-align: right;
		display: none;
	}
	footer .items .item .edit a{
    	float: right;
	}
	footer .items .item .edit img{
		width: 30px;
	}
	footer .items .item .edit img:hover{
		cursor: pointer;
		opacity: .7;
	}
	footer .items .item:hover .edit{
    	display: block;
		grid-template-columns: auto auto;
	}
	footer .pagination{
		text-align: center;
		margin-top: 20px;
	}

    @media only screen and (max-width: 600px){
        footer .items{
            grid-template-columns: 100%;
        }
        footer .items .item .edit img{
		    width: 35px;
	    }
    }
&lt;/style&gt;</code></pre><p>&nbsp;</p><p>ក្រោយ​ពី​ត្រូវ​បាន​កែប្រែ​រួច​ហើយ ទិន្នន័យ​នៃ​ការផ្សាយ​អាច​ត្រូវ​បញ្ជូន​ទៅ​ជំនួស​ទិន្នន័យ​ចាស់​នៅ​ក្នុង​មូលដ្ឋាន​ទិន្នន័យ។ ក៏ប៉ុន្តែ​មុន​នឹង​បញ្ជូន​ទិន្នន័យ​ដែល​ត្រូវ​បាន​កែប្រែ​នេះ​ទៅ​កាន់​មូលដ្ឋាន​ទិន្នន័យ ​ចាំបាច់ត្រូវ​ត្រួត​ពិនិត្យ​មើល​ថា តើ​អ្នក​កែប្រែ​ទិន្នន័យ​នេះ​មាន​សិទ្ធិ​ក្នុង​ការកែប្រែ​ទិន្នន័យ​ដែរ​ឬ​ទេ​។ ការត្រួត​ពិនិត្យ​ត្រូវ​ធ្វើ​ឡើងដោយ​ពិនិត្យ​មើល​តួនាទី​របស់​អ្នក​កែប្រែ បើ​អ្នក​នោះ​គ្មាន​សិទ្ធិ​ទេ ទិន្នន័យ​នឹងត្រូវចាត់ទុកជា​មោឃៈ គឺ​គ្មាន​ការបញ្ជូន​ទិន្នន័យ​នេះ​ទៅ​មូលដ្ឋាន​ទិន្នន័យ​ឡើយ​។&nbsp;</p><p>&nbsp;</p><p>មួយវិញទៀត ​អ្នក​និពន្ធ​ទាំងឡាយ​ដែល​មាន​តួនាទី​ត្រឹម​តែ​ជា «Author» ​​​​​​នឺងមាន​សិទ្ធិ​កែប្រែតែ​ការផ្សាយ​ទាំងឡាយ​ដែល​ត្រូវ​បាន​តែង​និពន្ធ​ដោយ​ខ្លួន​គេ​ផ្ទាល់​តែប៉ុណ្ណោះ​​ ពួក​គេ​​នឹង​មិន​អាច​កែប្រែ​អត្ថបទនៃ​​ការផ្សាយ​របស់​អ្នក​ដទៃ​បាន​ឡើយ​។ មាន​តែ​អ្នក​និពន្ធ​ដែល​មាន​តួនាទី​ជា « Admin» ប៉ុណ្ណោះ ដែល​មាន​សិទ្ធិ​កែប្រែ​អត្ថបទ​នៃ​ការផ្សាយ​ណា​ក៏​បាន​៕</p><p>&nbsp;</p><p>Netlify: <a href="https://khmerweb-dynamic-blog.netlify.app/login">https://khmerweb-dynamic-blog.netlify.app/login</a></p><p>GitHub: <a href="https://github.com/khmerweb/dynamic-blog">https://github.com/khmerweb/dynamic-blog</a></p>