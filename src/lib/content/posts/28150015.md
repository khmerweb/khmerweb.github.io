---
id: '28150015'
title: 'រក្សា​ទិន្នន័យ​ទុក​ជា MD'
categories: 'Node.js, Sveltekit'
thumb: ''
date: '2025-10-01T10:37:35'
bookTitle: 'Desktop App with Electron'
bookThumb: ''
bookChapter: 'Electron & SvelteKit'
videos: ''
---
<p>ក្រោយ​ពី​ត្រូវ​បាន​បង្កើត​ឡើង​រួច​ហើយ យើង​អាច​រក្សា​ទិន្នន័យ​ទាំងនោះ​ទុក​ជា​ឯកសារ​មាន​ប្រភេទ​ជា MD (Markdown) សំរាប់​យក​ទៅ​ប្រើការ​​ជាមួយ​នឹង​​កម្មវិធី​គេហទំព័រ​ឬ​អ្វី​ៗ​ផ្សេង​ៗ​ទៀត​។ យ៉ាងណាម៉ិញ ការរក្សា​ឯកសារ​ទាំងនោះ​ទុក​ ​ត្រូវ​ធ្វើឡើង​ដោយ​យក​ក្បួនខ្នាតនៅ​ក្នុង​កញ្ចប់ Node.js មក​ប្រើប្រាស់ ដូចនេះ ចាំបាច់​ត្រូវ​ធ្វើ​ឡើង​នៅ​ក្នុង​ឯកសារ main.ts ព្រោះ​មាន​តែ​ឯកសារ​នេះ​ទេ ដែល​អាច​ប្រើប្រាស់​ក្បួន​ខ្នាត​នៅ​ក្នុង​កញ្ចប់ Node.js ។</p><p>&nbsp;</p><p>យើង​បាន​ដឹង​រួច​មក​ហើយ​ថា ការភ្ជាប់​ទំនាក់ទំនង​រវាង​កម្មវិធី SvelteKit និង​ឯកសារ main.ts អាច​ត្រូវ​ធ្វើឡើង​តាម​រយៈ​ឯកសារ preload.cjs ព្រោះ​ដើម្បី​រក្សា​សុវត្ថិភាព​អោយ​បាន​រឹងមាំ ទប់ទល់​នឹង​ជន​ខិលខូច​ទាំង​​ឡាយ ដែល​មាន​បំណង​ចង់​បំបែក​កូដ​រប​ស់​យើង​។ ហើយ​ការភ្ជាប់​ទំនាក់ទំនង​ដោយ​ផ្ទាល់​រវាង​កម្មវិធី SvelteKit និង​ឯកសារ main.ts អាច​ផ្តល់​លទ្ធភាព​ដល់​ជន​ខិលខូច​អាច​បំបែក​កូដ​របស់​យើង​បាន​​ក្រោម​ហេតុផល​​ផ្សេង​ៗ​។ ជាលទ្ធផល កូដ​ភ្ជាប់​ទំនាក់ទំនង​រវាង​កម្មវិធី SvelteKit និង​ឯកសារ main.ts ក្នុង​ការរក្សា​ទិន្នន័យ​ទុក អាច​ត្រូវ​ធ្វើ​ឡើង​នៅ​ក្នុង​ឯកសារ preload.cjs ដូច​ខាង​ក្រោម​នេះ​៖</p><pre><code class="js javascript js-code">// electron/preload.cjs
const { contextBridge, ipcRenderer } = require('electron')

contextBridge.exposeInMainWorld('electronAPI', {
    getWindowHeight: () =&gt; ipcRenderer.invoke('get-window-height'),
    onUpdateWindowHeight: (callback) =&gt; ipcRenderer.on('update-window-height', callback),
    saveFile: (fileContent, filePath) =&gt; ipcRenderer.invoke('save-file', fileContent, filePath),
})</code></pre><p>&nbsp;</p><p>នៅ​ក្នុង​ឯកសារ main.ts ដើម្បី​ឆ្លើយ​តប​នឹង​ការភ្ជាប់ទំនាក់ទំនង​នេះ យើង​ចាំបាច់​ត្រូវ​បង្កើត​ក្បួន​មួយ​ដូច​ខាង​ក្រោម​៖</p><pre><code class="typescript">// electron/main.ts
import { app, BrowserWindow, Menu, ipcMain, dialog } from 'electron';
...
import fileTools from "./file-utils.ts";

ipcMain.handle('save-file', async (event, fileContents, filePath) =&gt; {
    const result = await fileTools.saveFile(fileContents, filePath, dialog);
    return result;
})</code></pre><p>&nbsp;</p><p>កូដ​ដែល​ត្រូវ​នាំចូល​យក​ទៅ​ប្រើប្រាស់​នៅ​ក្នុងក្បួន​ខាង​លើ អាច​ត្រូវ​សរសេរ​ឡើង​នៅ​ក្នុង​ឯកសារ​ដាច់​ដោយ​ឡែក​មួយ តែ​មុន​នឹង​ចាប់ផ្តើម យើង​ត្រូវ​តំលើង​កញ្ចប់ electron-store សំរាប់​រក្សា​ទិន្នន័យ​ទុក និង short-unique-id សំរាប់​បង្កើត UUID៖</p><pre><code>npm install electron-store  short-unique-id</code></pre><pre><code class="typescript">import fs from 'fs';
import path from 'node:path';
import ShortUniqueId from 'short-unique-id';
const { randomUUID } = new ShortUniqueId({ length: 15, dictionary: 'number' });

import Store from 'electron-store';
interface FolderPath {
    folderPath: string;
}
const store = new Store&lt;FolderPath&gt;();

class FileTools{
	async saveFile(fileContents:string, file_path:string, dialog:any){
        let fileContent = JSON.parse(fileContents)
        const frontMatter = fileContent.frontMatter

        if(file_path.length){
            const filName = path.basename(file_path)
            const lastDotIndex = filName.lastIndexOf('.');
            frontMatter.id = filName.substring(0, lastDotIndex);
        }else{
            frontMatter.id = randomUUID()
        }
        
        const id = frontMatter.id

        const content = fileContent.content
        const yamlFrontMatter = Object.entries(frontMatter)
            .map(([key, value]) =&gt; {
                if (Array.isArray(value)) {
                    return `${key}:\n${value.map(item =&gt; `  - '${item}'`).join('\n')}`
                }
                const safeValue = String(value).replace(/'/g, "''").replace(/\r?\n|\r/g, ' ')
                return `${key}: '${safeValue}'`
            })
            .join('\n')

        fileContent = `---\n${yamlFrontMatter}\n---\n${content}`
    
        if(!file_path.length){
            const { canceled, filePath } = await dialog.showSaveDialog({
                title: 'Save File',
                defaultPath: `${id}.md`,
                filters: [
                    { name: 'Markdown Files', extensions: ['md'] },
                    { name: 'All Files', extensions: ['*'] }
                ]
            })

            if (!canceled &amp;&amp; filePath) {
                try {
                    fs.writeFileSync(filePath, fileContent)
                    const folderPath = path.dirname(filePath)
                    store.set('folderPath', folderPath);
                    return { success: true, filePath }
                } catch (error: any) {
                    console.error('Failed to save file:', error)
                    return { success: false, error: error.message }
                }
            } else {
                return { success: false, canceled: true }
            }
        }else{
            try {
                fs.writeFileSync(file_path, fileContent)
                return { success: true, filePath:file_path }
            } catch (error: any) {
                console.error('Failed to save file:', error)
                return { success: false, error: error.message }
            }
        }
    }
}

export default new FileTools()</code></pre><p>&nbsp;</p><p>នៅ​ក្នុង​កម្មវិធី SvelteKit ដើម្បី​ភ្ជាប់​ទំនាក់​ទំនង​ជាមួយ​នឹង​ក្បួន​រក្សា​ឯកសារ​ទុក​នៅ​ក្នុង​ឯកសារ main.ts យើង​ត្រូវ​សរសេរ​កូដ​ដូច​ខាង​ក្រោម​នេះ​​​​​​​​​​​​៖</p><pre><code class="typescript">// src/lib/store/state.svelte.ts
export const dialogState = $state({
    showDialog: false,
    message: '',
});

interface ElementState {
    category: string | undefined;
    categories: string | undefined;
    json: string;
    type:  string | undefined;
    id: string | undefined;
    status: string | undefined;
    videos: any[];
}

export const eleState: ElementState = $state({
	category: undefined,
    categories: '',
    json: '',
    type: undefined,
    id: undefined,
    status: undefined,
    videos: [],
});

export const fileState = $state({
    filePath: '',
    fileResult: {success: false, detailedList:[], count:0},
    
})</code></pre><pre><code class="typescript">// src/routes/editor-utils.ts
import { eleState, dialogState, fileState } from '$lib/store/state.svelte';

class EditorTools{
	...
	async submitForm(event: Event){
        event.preventDefault()
        if(eleState.videos.length){
            let newVideos = []
            interface VideoType{
                type: string;
                id: string;
                status: string;
            }
            let part: VideoType = {type:'', id:'', status:'' }
            let key: keyof VideoType = 'type'

            for(let v=0; v&lt;eleState.videos.length; v++){
                for(let j=0; j&lt;3; j++){
                    if(j===0){
                        key = 'type';
                    }else if(j===1){
                        key = 'id';
                    }else if(j===2){
                        key = 'status';
                    }

                    const elementsWithClass = document.querySelectorAll(`.${key}`);
                    const specificElement = elementsWithClass[v] as HTMLInputElement;
                    part[key] = specificElement.value;
                }

                newVideos.push({...part})
            }

            eleState.json = JSON.stringify(newVideos)
        }

        const formData = new FormData(event.target as HTMLFormElement)
        const title = formData.get('title')
        const content = (window as any).tinymce.activeEditor.getContent()
        const categories = formData.get('categories')
        const thumb = formData.get('thumb')
        const date = formData.get('date')
        const bookTitle = formData.get('book-title')
        const bookThumb = formData.get('book-thumb')
        const bookChapter = formData.get('book-chapter')
        const videos = formData.get('videos')

        const submittedButton = (event as SubmitEvent).submitter
        const buttonId = submittedButton?.id

        if(buttonId === 'md-file'){
            const frontMatter = { id:'', title, categories, thumb, date, bookTitle, bookThumb, bookChapter, videos}
            let result = await (window as any).electronAPI.saveFile(JSON.stringify({frontMatter, content}), fileState.filePath)
            if(result.success){
                dialogState.showDialog = true;
                dialogState.message = "រក្សា​ឯកសារ​ទុក​បាន​ដោយ​​ជោគជ័យ!";
                fileState.filePath = result.filePath;                
            }else{
                dialogState.showDialog = true;
                dialogState.message = "មាន​បញ្ហា​ក្នុង​ការរក្សា​ឯកសារ​ទុក​.";
            }
        }
    }
}

export default new EditorTools()</code></pre><pre><code class="svelte">&lt;!--src/routes/+page.svelte--&gt;
...
import tool from "./editor-utils";
import { eleState, fileState } from '$lib/store/state.svelte';
...
{#each eleState.videos as video, i}
&lt;input class='type' value={video.type} required /&gt;
&lt;input class='id' value={video.id} /&gt;
&lt;input class='status' value={video.status} required /&gt;
&lt;button type="button" title="Delete" onclick={tool.deleteRow} class="episode"&gt;{eleState.videos.length-i}&lt;/button&gt;
{/each}
...</code></pre><p>&nbsp;</p><figure class="image"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhmKxzKXSZqZS8wWrsdcF_XS5nYfidtoE86xRSApD0qqO3o7wnpm2kMr-ca_LYwH8tatNYecW-Q23lltJSJsISx-Vl0G-wgYPnJJpVZz70BxtpsMvg_o8xHu_2gOX3rz1zqJQEjmocOrgvnBrgqm7aAPYAyIyAtgtDRL3GCkYhajUrNVl8srPQ_xDG44XQ/s1600/Capture.PNG"></figure>